var R=Object.defineProperty;var S=(a,e,t)=>e in a?R(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var u=(a,e,t)=>S(a,typeof e!="symbol"?e+"":e,t);import{_ as E,H as F}from"./Header-jlxeZXVD.js";import{_ as L}from"./ChatPanel-DWOakeds.js";import{ak as U,aj as l,aW as $,az as g,aA as m,aD as p,aO as B,b2 as T,aG as v,aE as k,aH as j,aB as M,aF as N,ay as w,am as z,au as _}from"./vendor-DqHIQWU1.js";import{_ as y}from"./message-DsTL7g5X.js";import{a as O,s as V}from"./userInfo-CSbayTML.js";import{d as A,a as H}from"./user-BZG51SbY.js";import"./index-bEem1MK9.js";import"./no-data-ou6-36FL.js";import"./remixicon-l0sNRNKZ.js";import"./utils-DVDKZiQc.js";import"./Question-DbNPOHdm.js";import"./oneNote-D4VVWFj3.js";/* empty css                                                                */import"./file-D7E9LNHg.js";const I={class:"flex-1 p-3 font-bold bg-white/90 dark:bg-neutral-900/40"},P=["onClick"],W={key:0,class:"absolute left-8 top-0 block w-4 h-4 bg-red-600 text-slate-50 text-center rounded-xl text-xs"},D={__name:"Contacts",props:{fold:{type:Boolean,default:!0},contacts:{type:Array,default:()=>[]}},emits:["toggleFold","menuChange"],setup(a,{emit:e}){U();const t=a,s=l(!0),o=l(""),r=e,n=()=>{s.value=!0,r("toggleFold",!0)},h=i=>{o.value=i._id,r("chatTo",i)};return $(()=>t.fold,(i,f)=>{s.value=i},{immediate:!0}),(i,f)=>(g(),m("div",{class:M(["flex flex-col fixed top-16 bottom-0 backdrop-blur overflow-y-auto z-20 bg-black/10 dark:bg-neutral-900/40 w-full lg:w-80 pr-24 lg:pr-0 transition-transform duration-300 ease-out delay-100 lg:translate-x-0",s.value?"translate-x-[-100%]":"translate-x-0"]),onClick:N(n,["stop"])},[p("nav",I,[p("ul",null,[(g(!0),m(B,null,T(a.contacts,(c,C)=>(g(),m("li",{key:c._id,onClick:x=>h(c),class:"relative h-12 leading-[3rem] px-2 border-b border-slate-300/20 cursor-pointer"},[v(E,{class:"mr-4",size:"md",file:c.avatar},null,8,["file"]),c.noReadCount>0?(g(),m("span",W,k(c.noReadCount),1)):j("",!0),p("span",{class:M(o.value===c._id?"text-blue-500":"text-slate-500 hover:text-blue-300 dark:text-slate-300")},k(c.name),3)],8,P))),128))])])],2))}},J=y(D,[["__scopeId","data-v-82e25ca2"]]),G=a=>w.get("/message/getContactMessages",{params:{contact:a}}).then(e=>e&&e.data&&e.data.success?e.data.data:Promise.reject(e&&e.data&&e.data.message)),q=(a,e,t)=>w.post("/message/updateContactMessageStatus",{from:a,to:e,status:t}).then(s=>s&&s.data&&s.data.success?s.data.data:Promise.reject(s&&s.data&&s.data.message)),K="ws://111.229.165.93:3001";class Q{constructor(){u(this,"sender",l());u(this,"recipient");u(this,"contacts",l([]));u(this,"messages",l([]));u(this,"socket");u(this,"useMessages",()=>this.messages);u(this,"useUserId",()=>this.sender);this.sender=l(O()),this.recipient="",A().then(e=>{this.contacts.value=e||[]}),this.socket=new WebSocket(K),this.bindEvent()}sendMessage(e){e&&(this.socket.send(JSON.stringify(e)),this.appendMessage(e))}appendMessage(e,t=!1){let{from:s,to:o}=e,r=t?s:o;(r===this.recipient||!t)&&(this.messages.value=this.messages.value.concat([e]));let n=this.contacts.value.find(({_id:h})=>h===r);n&&(n.noReadCount=n.noReadCount?n.noReadCount+1:1,n.messages&&n.messages.push(e))}close(){this.socket.close(),this.contacts=null,this.messages=null}bindEvent(){this.socket.addEventListener("open",()=>{console.log("Connection opened"),this.sender&&this.sender.value?this.socket.send(this.sender.value):H().then(e=>{this.sender.value=e._id,V(e),this.socket.send(e._id)})}),this.socket.addEventListener("message",e=>{let t=e.data;console.log(`Received message: ${t}`),t=JSON.parse(t),Object.prototype.toString.call(t)==="[object Array]"?t.forEach(s=>{this.appendMessage(s,!0)}):this.appendMessage(t,!0)}),this.socket.addEventListener("close",()=>{console.log("Connection closed")})}getContacts(){var e;return(e=this.contacts)==null?void 0:e.value}useContacts(){return this.contacts}setContacts(e){this.contacts.value=e}changeRecipient(e){this.recipient=e;let t=this.contacts.value.find(({_id:o})=>o===e),s=t==null?void 0:t.messages;s?this.messages.value=s:G(e).then(o=>{this.messages.value=o||[],this.contacts.value.find(({_id:r})=>r===e).messages=this.messages.value}),t!=null&&t.noReadCount&&q(e,this.sender.value,"read").then(()=>{t.noReadCount=0})}onChat(e){this.sendMessage({from:this.sender.value,to:this.recipient,content:e})}}const X={class:"flex flex-col w-full h-screen"},Y={class:"flex-1 flex flex-col w-full lg:pl-80 bg-slate-300/20 overflow-hidden"},Z={__name:"Chat",setup(a){let e=new Q;const t=l(!0),s=l(!1),o=e.useContacts(),r=e.useMessages(),n=e.useUserId(),h=l(!1),i=l(),f=d=>{if(d!==void 0){t.value=d;return}t.value=!t.value},c=({_id:d,avatar:b})=>{e.changeRecipient(d),i.value={userId:d,avatar:b},h.value=!0},C=()=>{i.value=void 0},x=d=>{e.onChat(d)};return z(()=>{e.close(),e=null}),(d,b)=>(g(),m("div",X,[v(F,{onToggleFold:f,fold:t.value},null,8,["fold"]),v(J,{class:"",onChatTo:c,fold:t.value,contacts:_(o),onToggleFold:f},null,8,["fold","contacts"]),p("div",Y,[v(L,{placeholder:"咱们开始聊天吧...",editable:h.value,messages:_(r),loading:s.value,onChart:x,owner:_(n),roleProperty:"from",chatter:i.value,onClearChatter:C},null,8,["editable","messages","loading","owner","chatter"])])]))}},fe=y(Z,[["__scopeId","data-v-72d4f861"]]);export{fe as default};
